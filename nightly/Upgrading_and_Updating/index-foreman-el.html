<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<title>Upgrading and Updating Foreman&#160;server</title>
<link rel="stylesheet" href="./foreman-el.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Upgrading and Updating Foreman&#160;server</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#upgrading_process_overview">1. Upgrade Overview</a>
<ul class="sectlevel2">
<li><a href="#upgrading_prerequisites">1.1. Prerequisites</a></li>
<li><a href="#upgrade_paths">1.2. Upgrade Paths</a></li>
<li><a href="#following_the_progress_of_the_upgrade">1.3. Following the Progress of the Upgrade</a></li>
<li><a href="#upgrading_capsules-separately-from-satellite_upgrade-guide">1.4. Upgrading Smart&#160;Proxies Separately from Foreman</a></li>
</ul>
</li>
<li><a href="#cloning_satellite_server">2. Cloning Foreman&#160;server</a>
<ul class="sectlevel2">
<li><a href="#sec-Cloning_Workflow_Overview">2.1. Cloning Process Overview</a></li>
<li><a href="#sec-Cloning_Prerequisites">2.2. Prerequisites</a></li>
<li><a href="#sec-Pulp_Data_Considerations">2.3. Pulp Data Considerations</a></li>
<li><a href="#sec_Cloning_Satellite_Server">2.4. Cloning Foreman&#160;server</a></li>
</ul>
</li>
<li><a href="#_upgrading_red_hat_satellite">3. Upgrading Red Hat Satellite</a>
<ul class="sectlevel2">
<li><a href="#upgrading_satellite_server_parent">3.1. Upgrading Foreman&#160;server</a></li>
<li><a href="#synchronizing_the_new_repositories">3.2. Synchronizing the New Repositories</a></li>
<li><a href="#upgrading_capsule_server">3.3. Upgrading Smart&#160;Proxy&#160;servers</a></li>
<li><a href="#upgrading_clients">3.4. Upgrading Foreman Clients</a></li>
</ul>
</li>
<li><a href="#_post_upgrade_tasks">4. Post-Upgrade Tasks</a>
<ul class="sectlevel2">
<li><a href="#upgrading_discovery_parent">4.1. Upgrading Discovery</a></li>
<li><a href="#upgrading_virt_who">4.2. Upgrading virt-who</a></li>
<li><a href="#removing_satellite_tools_repository">4.3. Removing the Previous Version of the Foreman Tools Repository</a></li>
<li><a href="#reclaiming-mongodb-space_upgrade-guide">4.4. Reclaiming MongoDB Space</a></li>
<li><a href="#reclaiming-postgresql-space-after-an-upgrade_upgrade-guide">4.5. Reclaiming PostgreSQL Space</a></li>
<li><a href="#upgrading_the_mongodb_storage_engine">4.6. Upgrading the MongoDB Storage Engine</a></li>
<li><a href="#post_upgrade-updating-templates-parameters">4.7. Updating Templates, Parameters, Lookup Keys and Values</a></li>
<li><a href="#tuning-with-predefined-profiles_upgrade-guide">4.8. Tuning Foreman&#160;server with Predefined Profiles</a></li>
</ul>
</li>
<li><a href="#_updating_satellite_server_capsule_server_and_content_hosts">5. Updating Satellite Server, Capsule Server, and Content Hosts</a>
<ul class="sectlevel2">
<li><a href="#updating_satellite_server_to_next_minor_version">5.1. Updating Foreman&#160;server</a></li>
<li><a href="#_updating_disconnected_foremanserver">5.2. Updating Disconnected Foreman&#160;server</a></li>
<li><a href="#updating_capsule_server_to_next_minor_version">5.3. Updating Smart&#160;Proxy&#160;server</a></li>
<li><a href="#updating_content_hosts_to_next_minor_version">5.4. Updating Content Hosts</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="upgrading_process_overview">1. Upgrade Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter details the prerequisites and available upgrade paths to Foreman 6.9-beta. Review this information before upgrading your current Foreman installation.</p>
</div>
<div class="paragraph">
<p>In this guide, the terms update, upgrade, and migrate have the following meanings:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Upgrading</dt>
<dd>
<p>The process of advancing your Foreman&#160;server and Smart&#160;Proxy&#160;server installations from a y-stream release to the next, for example Foreman 6.8 to Foreman 6.9-beta.</p>
</dd>
<dt class="hdlist1">Updating</dt>
<dd>
<p>The process of advancing your Foreman&#160;server and Smart&#160;Proxy&#160;server installations from a z-stream release to the next, for example Foreman 6.9-beta.0 to Foreman 6.9-beta.1.</p>
</dd>
<dt class="hdlist1">Migrating</dt>
<dd>
<p>The process of moving an existing Foreman installation to another Red&#160;Hat Enterprise&#160;Linux server.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For interactive upgrade instructions, you can also use the Foreman Upgrade Helper on the Red&#160;Hat Customer Portal. This application provides you with an exact guide to match your current version number. You can find instructions that are specific to your upgrade path, as well as steps to prevent known issues. For more information, see <a href="https://access.redhat.com/labs/satelliteupgradehelper/">Foreman Upgrade Helper</a> on the customer portal.</p>
</div>
<div class="paragraph">
<p>Note that you can upgrade Smart&#160;Proxies separately from Foreman. For more information, see <a href="#upgrading_capsules-separately-from-satellite_upgrade-guide">Upgrading Smart&#160;Proxies Separately from Foreman</a>.</p>
</div>
<div class="sect2">
<h3 id="upgrading_prerequisites">1.1. Prerequisites</h3>
<div class="paragraph">
<p>Upgrading to Foreman 6.9-beta affects your entire Foreman infrastructure. Before proceeding, complete the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Review this guide so that you are aware of the upgrade process and its impact.</p>
</li>
<li>
<p>Plan your upgrade path. For more information, see <a href="#upgrade_paths">Upgrade Paths</a>.</p>
</li>
<li>
<p>Until <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1665893">BZ#1665893</a> is resolved, read the Knowledgebase solution <a href="https://access.redhat.com/solutions/3803901">Candlepin gets stuck during startup forever, logging huge thread dump to error.log</a>, and perform the resolution steps before beginning the upgrade.</p>
</li>
<li>
<p>Plan for the required downtime. Foreman services are shut down during the upgrade. The upgrade process duration might vary depending on your hardware configuration, network speed, and the amount of data that is stored on the server.</p>
<div class="paragraph">
<p>Upgrading Foreman takes approximately 1 - 2 hours.</p>
</div>
<div class="paragraph">
<p>Upgrading Smart&#160;Proxy takes approximately 10 - 30 minutes.</p>
</div>
</li>
<li>
<p>Ensure that you have sufficient storage space on your server. For more information, see <a href="https://docs.theforeman.org/nightly/Installing_Server_on_Red_Hat/index-foreman-el.html##preparing-environment-for-satellite-installation">Preparing your Environment for Installation</a> in <em>Installing Foreman&#160;server from a Connected Network</em> and <a href="https://docs.theforeman.org/nightly/Installing_Proxy_on_Red_Hat/index-foreman-el.html#preparing-environment-for-capsule-installation">Preparing your Environment for Installation</a> in <em>Installing Smart&#160;Proxy&#160;server</em>.</p>
</li>
<li>
<p>Back up your Foreman&#160;server and all Smart&#160;Proxy&#160;servers. For more information, see <a href="https://docs.theforeman.org/nightly/Administering_Red_Hat_Satellite/index-foreman-el.html#backing-up-satellite-server-and-capsule-server">Backing Up Foreman&#160;server and Smart&#160;Proxy&#160;server</a> in the <em>Administering Foreman 6.8</em> guide.</p>
</li>
<li>
<p>Plan for updating any scripts you use that contain Foreman API commands because some API commands differ between versions of Foreman. For more information about changes in the API, see the Knowledgebase article <a href="https://access.redhat.com/articles/4396911">API Changes Between Foreman Versions</a> on the Red&#160;Hat Customer Portal.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you customize configuration files, manually or use a tool such as Hiera, these customizations are overwritten when the installation script runs during upgrading or updating. You can use the <code>--noop</code> option with the foreman-installer script to test for changes. For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in Foreman config files during an upgrade.</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="upgrade_paths">1.2. Upgrade Paths</h3>
<div class="paragraph">
<p>You can upgrade to Foreman from the previous version. Foreman&#160;servers and Smart&#160;Proxy&#160;servers on earlier versions must first be upgraded to the Foreman version previous to this. For more information, see the Foreman 6.8 Upgrading and Updating Foreman guide.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/satellite_6.4_upgrade_paths.png" alt="Overview of Foreman 6.9-beta Upgrade Paths">
</div>
<div class="title">Figure 1. Overview of Foreman 6.9-beta Upgrade Paths</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Upgrading from the Beta to GA version is not supported.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The high level steps in upgrading to Foreman 6.9-beta are as follows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clone your existing Foreman&#160;servers. For more information, see <a href="#cloning_satellite_server">Cloning Foreman&#160;server</a>.</p>
</li>
<li>
<p>Upgrade Foreman&#160;server and all Smart&#160;Proxy&#160;servers to Foreman 6.9-beta. For more information, see <a href="#upgrading_satellite_server_parent">Upgrading Foreman&#160;server</a>.</p>
</li>
<li>
<p>Upgrade to <a href="https://yum.theforeman.org/client/2.4/" class="bare">https://yum.theforeman.org/client/2.4/</a> on all Foreman clients. For more information, see <a href="#upgrading_clients">Upgrading Foreman Clients</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="following_the_progress_of_the_upgrade">1.3. Following the Progress of the Upgrade</h3>
<div class="paragraph">
<p>Because of the lengthy upgrade time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>. You can also see the <code>screen</code> manual page for more information.</p>
</div>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running you can see the logs in <code>/var/log/foreman-installer/satellite.log</code> to check if the process completed successfully.</p>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_capsules-separately-from-satellite_upgrade-guide">1.4. Upgrading Smart&#160;Proxies Separately from Foreman</h3>
<div class="paragraph">
<p>You can upgrade Foreman to the version 6.9-beta and keep Smart&#160;Proxies at the version 6.8 until you have bandwidth to upgrade them too.</p>
</div>
<div class="paragraph">
<p>All the functionality that worked previously works on 6.8 Smart&#160;Proxies. However, the functionality added in the 6.9-beta release will not work until you upgrade Smart&#160;Proxies to 6.9-beta.</p>
</div>
<div class="paragraph">
<p>Upgrading Smart&#160;Proxies after upgrading Foreman can be useful in the following example scenarios:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you want to have several smaller outage windows instead of one larger window.</p>
</li>
<li>
<p>If Smart&#160;Proxies in your organization are managed by several teams and are located in different locations.</p>
</li>
<li>
<p>If you use a load-balanced configuration, you can upgrade one load-balanced Smart&#160;Proxy and keep other load-balanced Smart&#160;Proxies at 1 version lower. This allows you to upgrade all Smart&#160;Proxies one after another without any outage.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloning_satellite_server">2. Cloning Foreman&#160;server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you upgrade Foreman&#160;server, you can optionally create a clone of your Foreman to ensure that you do not lose any data while you upgrade. After your upgrade is complete, you can then decommission the earlier version of Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>Use the following procedures to clone your Foreman instances to preserve your environments in preparation for upgrade.</p>
</div>
<div class="paragraph">
<p>The Foreman clone tool does not support migrating a Smart&#160;Proxy&#160;server to Red Hat Enterprise Linux 7. Instead you must backup the existing Smart&#160;Proxy&#160;server, restore it on Red Hat Enterprise Linux 7, then reconfigure the Smart&#160;Proxy&#160;server.</p>
</div>
<div class="paragraph">
<div class="title">Terminology</div>
<p>Ensure that you understand the following terms:</p>
</div>
<div class="paragraph">
<p><strong>Source server</strong>: the server that you clone</p>
</div>
<div class="paragraph">
<p><strong>Target server</strong>: the new server that you copy files to and clone the source server to.</p>
</div>
<div class="sect2">
<h3 id="sec-Cloning_Workflow_Overview">2.1. Cloning Process Overview</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Back up the source server.</p>
</li>
<li>
<p>Clone the source server to the target server.</p>
</li>
<li>
<p>Power off the source server.</p>
</li>
<li>
<p>Update the network configuration on the target server to match the target server’s IP address with its new host name.</p>
</li>
<li>
<p>Restart <strong>goferd</strong> in Content hosts and Smart&#160;Proxies to refresh the connection.</p>
</li>
<li>
<p>Test the new target server.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="sec-Cloning_Prerequisites">2.2. Prerequisites</h3>
<div class="paragraph">
<p>To clone Foreman&#160;server, ensure that you have the following resources available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A minimal install of Red&#160;Hat Enterprise Linux 7 server to become the target server. Do not install Red&#160;Hat Enterprise Linux 7 software groups, or third-party applications. Ensure that your server complies with all the specifications of <a href="https://docs.theforeman.org/nightly/Installing_Server_on_Red_Hat/index-foreman-el.html#preparing-environment-for-satellite-installation">Preparing your Environment for Installation</a> in <em>Installing Foreman&#160;server</em>.</p>
</li>
<li>
<p>A backup from Foreman 6.8 that you make using the <code>foreman-maintain backup</code> script. You can use a backup with or without Pulp data.</p>
</li>
<li>
<p>A Foreman subscription for the target server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before you begin cloning, ensure the following conditions exist:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The target server is on an isolated network. This avoids unwanted communication with Smart&#160;Proxy&#160;servers and hosts</p>
</li>
<li>
<p>The target server has the capacity to store all your backup files from the source server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Customized configuration files</div>
<p>If you have any customized configurations on your source server that are not managed by the <code>foreman-installer</code> tool or Foreman backup process, you must manually back up these files.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec-Pulp_Data_Considerations">2.3. Pulp Data Considerations</h3>
<div class="paragraph">
<p>You can clone Foreman server without including Pulp data. However, for your cloned environment to work, you do require Pulp data. If the target server does not have Pulp data. it is not a fully working Foreman.</p>
</div>
<div class="paragraph">
<p>To transfer Pulp data to a target server, you have two options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone using backup with Pulp data</p>
</li>
<li>
<p>Clone using backup without Pulp data and copy <code>/var/lib/pulp</code> manually from source server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If your <code>pulp_data.tar</code> file is greater than 500 GB, or if you use a slow storage system, such as NFS, and your <code>pulp_data.tar</code> file is greater than 100 GB, do not include <code>pulp_data.tar</code> in the backup because this can cause memory errors during extraction. Copy the <code>pulp_data.tar</code> file from the source server to the target server.</p>
</div>
<div class="paragraph">
<div class="title">To back up without Pulp data</div>
<p>Follow the steps in the procedure in <a href="#sec_Cloning_Satellite_Server">Cloning Foreman&#160;server</a> and replace the steps that involve cloning with Pulp data with the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Perform a backup with MongoDB and PostgreSQL databases active excluding the Pulp data:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-maintain} backup offline --skip-pulp-content \
--assumeyes /var/backup</pre>
</div>
</div>
</li>
<li>
<p>Stop and disable the <code>foreman-maintain</code> services</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-maintain} service stop
# {foreman-maintain} service disable</pre>
</div>
</div>
</li>
<li>
<p>Copy the Pulp data to the target server:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rsync --archive --partial --progress --compress \
/var/lib/pulp <em>target_server.example.com:/var/lib/pulp</em></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Proceed to <a href="#sec-Cloning_to_Target">Cloning to the Target Server</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="sec_Cloning_Satellite_Server">2.4. Cloning Foreman&#160;server</h3>
<div class="paragraph">
<p>Use the following procedures to clone Foreman&#160;server. Note that because of the high volume of data that you must copy and transfer as part of these procedures, it can take a significant amount of time to complete.</p>
</div>
<div class="sect3">
<h4 id="sec-Preparing_Source_Server">2.4.1. Preparing the source server for cloning</h4>
<div class="paragraph">
<p>On the source server, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify the Pool ID of your Foreman subscription:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager list --consumed \
--matches 'Foreman'|grep "<em>Pool ID</em>:"|awk '{print $3}'</pre>
</div>
</div>
<div class="paragraph">
<p>Note the <em>Pool ID</em> for later use.</p>
</div>
</li>
<li>
<p>Remove the Foreman subscription.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager remove --serial=$(subscription-manager list \
--consumed \
--matches '{ProjectName}'|grep "Serial:"|awk '{print $2}')</pre>
</div>
</div>
</li>
<li>
<p>Determine the size of the Pulp data:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># du -sh /var/lib/pulp/</pre>
</div>
</div>
</li>
<li>
<p>If you have less than 500 GB of Pulp data, perform a backup with MongoDB and PostgreSQL databases active including the Pulp data. If you have more than 500 GB of Pulp data, skip the following steps and complete the steps in <a href="#sec-Pulp_Data_Considerations">Pulp Data Considerations</a> before you continue.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-maintain} backup offline --assumeyes /var/backup</pre>
</div>
</div>
</li>
<li>
<p>Stop and disable the <code>foreman-maintain</code> services:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-maintain} service stop
# {foreman-maintain} service disable</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Proceed to <a href="#sec-Cloning_to_Target">Cloning to the Target Server</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sec-Cloning_to_Target">2.4.2. Cloning to the Target Server</h4>
<div class="paragraph">
<p>To clone your server, complete the following steps on your target server:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>satellite-clone</code> tool defaults to using <code>/backup/</code> as the backup folder. If you copy to a different folder, update the <code>backup_dir</code> variable in the <code>/etc/satellite-clone/satellite-clone-vars.yml</code> file.</p>
</li>
<li>
<p>Place the backup files from the source Foreman in the <code>/backup/</code> folder on the target server. You can either mount the shared storage or copy the backup files to the <code>/backup/</code> folder on the target server.</p>
</li>
<li>
<p>Power off the source server.</p>
</li>
<li>
<p>Enter the following commands to register to the Customer Portal, attach subscriptions, and enable only the required subscriptions:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager register <em>your_customer_portal_credentials</em>
# subscription-manager attach --pool=<em>pool_ID</em>
# subscription-manager repos --disable=*
# subscription-manager repos \
--enable=rhel-7-server-rpms \
--enable=rhel-server-rhscl-7-rpms \
--enable=rhel-7-server-satellite-maintenance-6-rpms \
--enable=rhel-7-server-satellite-6.8-rpms</pre>
</div>
</div>
</li>
<li>
<p>Install the <code>satellite-clone</code> package</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {package-install-project} satellite-clone</pre>
</div>
</div>
<div class="paragraph">
<p>After you install the <code>satellite-clone</code> tool, you can adjust any configuration to suit your own deployment in the <code>/etc/satellite-clone/satellite-clone-vars.yml</code> file.</p>
</div>
</li>
<li>
<p>Run the <code>satellite-clone</code> tool.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># satellite-clone</pre>
</div>
</div>
</li>
<li>
<p>Reconfigure DHCP, DNS, TFTP and remote execution services. The cloning process disables these services on the target Foreman&#160;server to avoid conflict with the source Foreman&#160;server.</p>
</li>
<li>
<p>Reconfigure and enable DHCP, DNS, TFTP in the Foreman web UI. For more information, see <a href="https://docs.theforeman.org/nightly/Installing_Server_on_Red_Hat/index-foreman-el.html##configuring-external-services">Configuring External Services on Foreman&#160;server</a> in <em>Installing Foreman&#160;server</em>.</p>
</li>
<li>
<p>Enable remote execution:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {installer-scenario} \
--enable-foreman-plugin-remote-execution \
--enable-foreman-proxy-plugin-remote-execution-ssh</pre>
</div>
</div>
</li>
<li>
<p>Log on to the Foreman web UI, with the username <code>admin</code> and the password <code>changeme</code>. Immediately update the admin password to secure credentials.</p>
</li>
<li>
<p>Ensure that the correct organization is selected.</p>
</li>
<li>
<p>Navigate to <strong>Content</strong> &gt; <strong>Subscriptions</strong>, then click <strong>Manage Manifest</strong>.</p>
</li>
<li>
<p>Click the <strong>Refresh</strong> button, then click <strong>Close</strong> to return to the list of subscriptions.</p>
</li>
<li>
<p>Verify that the available subscriptions are correct.</p>
</li>
<li>
<p>Follow the instructions in the <code>/usr/share/satellite-clone/logs/reassociate_capsules.txt</code> file to restore the associations between Smart&#160;Proxies and their lifecycle environments.</p>
</li>
<li>
<p>Update your network configuration, for example, DNS, to match the target server’s IP address with its new host name. The <code>satellite-clone</code> tool changes the hostname to the source server&#8217;s hostname. If you want to change the hostname to something different, you can use the <code>satellite-change-hostname</code> tool. For more information, see <a href="https://docs.theforeman.org/nightly/Administering_Red_Hat_Satellite/index-foreman-el.html#sect-Red_Hat_Satellite-Administering_Red_Hat_Satellite-Renaming_a_Server">Renaming a Foreman or Smart&#160;Proxy&#160;server</a> in <em>Administrating Foreman</em>.</p>
</li>
<li>
<p>If the source server uses the <code>virt-who</code> daemon, install and configure it on the target server. Copy all the <code>virt-who</code> configuration files in the <code>/etc/virt-who.d/</code> directory from the source server to the same directory on the target server.  For more information, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.9-beta/html/configuring_virtual_machine_subscriptions_in_red_hat_satellite/index"><em>Configuring Virtual Machine Subscriptions</em></a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After you perform an upgrade using the following chapters, you can safely decommission the source server.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upgrading_red_hat_satellite">3. Upgrading Red Hat Satellite</h2>
<div class="sectionbody">
<div id="introduction_upgrading_satellite" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you have Foreman installed in a high availability configuration, contact Red&#160;Hat Support before upgrading to Foreman 6.9-beta.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Use the following procedures to upgrade your existing Foreman to Foreman 6.9-beta:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#upgrading_satellite_server_parent">Upgrading Foreman&#160;server</a></p>
</li>
<li>
<p><a href="#synchronizing_the_new_repositories">Synchronizing the New Repositories</a></p>
</li>
<li>
<p><a href="#upgrading_capsule_server">Upgrading Smart&#160;Proxy&#160;servers</a></p>
</li>
<li>
<p><a href="#upgrading_clients">Upgrading Foreman Clients</a></p>
</li>
<li>
<p><a href="#post-upgrade_tasks">[post-upgrade_tasks]</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Before upgrading, see <a href="#upgrading_prerequisites">Prerequisites</a>.</p>
</div>
<div class="sect2">
<h3 id="upgrading_satellite_server_parent">3.1. Upgrading Foreman&#160;server</h3>
<div class="paragraph">
<p>This section describes how to upgrade Foreman&#160;server from 6.8 to 6.9-beta. You can upgrade from any minor version of Foreman Server 6.8.</p>
</div>
<div id="upgrading_satellite_server_prerequisites" class="ulist">
<div class="title">Before You Begin</div>
<ul>
<li>
<p>Note that you can upgrade Smart&#160;Proxies separately from Foreman. For more information, see <a href="#upgrading_capsules-separately-from-satellite_upgrade-guide">Upgrading Smart&#160;Proxies Separately from Foreman</a>.</p>
</li>
<li>
<p>Review and update your firewall configuration prior to upgrading your Foreman&#160;server. For more information, see <a href="https://docs.theforeman.org/nightly/Installing_Server_on_Red_Hat/index-foreman-el.html#preparing-environment-for-satellite-installation">Preparing your environment for installation</a> in <em>Installing Foreman&#160;server</em>.</p>
</li>
<li>
<p>Ensure that you do not delete the manifest from the Customer Portal or in the Foreman Web UI because this removes all the entitlements of your content hosts.</p>
</li>
<li>
<p>Back up and remove all Foreman hooks before upgrading. Restore any hooks only after Foreman is known to be working after the upgrade is complete.</p>
</li>
<li>
<p>If you have edited any of the default templates, back up the files either by cloning or exporting them. Cloning is the recommended method because that prevents them being overwritten in future updates or upgrades. To confirm if a template has been edited, you can view its <strong>History</strong> before you upgrade or view the changes in the audit log after an upgrade. In the web UI, Navigate to <strong>Monitor</strong> &gt; <strong>Audits</strong> and search for the template to see a record of changes made. If you use the export method, restore your changes by comparing the exported template and the default template, manually applying your changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Smart&#160;Proxy Considerations</div>
<ul>
<li>
<p>If you use Content Views to control updates to a Smart&#160;Proxy&#160;server’s base operating system, or for the Smart&#160;Proxy&#160;server repository, you must publish updated versions of those Content Views.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you implemented custom certificates, you must retain the content of both the <code>/root/ssl-build</code> directory and the directory in which you created any source files associated with your custom
certificates.</p>
</div>
<div class="paragraph">
<p>Failure to retain these files during an upgrade causes the upgrade to fail. If
these files have been deleted, they must be restored from a backup in order for
the upgrade to proceed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Configuring the BASH shell</div>
<p>The BASH shell stores the location of a binary in a hash table. During the upgrade, the location of the <code>foreman-maintain</code> script is changed, but BASH does not register this change, and <code>foreman-maintain</code> fails if it calls the script after the change.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Optional: Before the upgrade, users of the BASH shell can set the <code>checkhash</code> option temporarily to ensure <code>foreman-maintain</code> works after the installer completes. Enter a command as follows in your BASH shell:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># shopt -s checkhash</pre>
</div>
</div>
</li>
<li>
<p>After a successful or failed upgrade, in all currently running BASH shells, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hash -d {foreman-maintain} 2&gt; /dev/null</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Upgrade Scenarios</div>
<ul>
<li>
<p>To upgrade a Foreman&#160;server connected to the Red&#160;Hat Content Delivery Network, proceed to <a href="#upgrading_a_connected_satellite_server">Upgrading a Connected Foreman&#160;server</a>.</p>
</li>
<li>
<p>To upgrade a Foreman&#160;server not connected to the Red&#160;Hat Content Delivery Network, proceed to <a href="#upgrading_a_disconnected_satellite">[upgrading_a_disconnected_satellite]</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">FIPS mode</div>
<p>You cannot upgrade Foreman&#160;server from a RHEL base system that is not operating in FIPS mode to a RHEL base system that is operating in FIPS mode.</p>
</div>
<div class="paragraph">
<p>To run Foreman&#160;server on a Red&#160;Hat Enterprise Linux base system operating in FIPS mode, you must install Foreman on a freshly provisioned RHEL base system operating in FIPS mode. For more information, see <a href="https://docs.theforeman.org/nightly/Installing_Server_on_Red_Hat/index-foreman-el.html#preparing-environment-for-satellite-installation">Preparing your environment for installation</a> in <em>Installing Foreman&#160;server</em>.</p>
</div>
<div class="sect3">
<h4 id="upgrading_a_connected_satellite_server">3.1.1. Upgrading a Connected Foreman&#160;server</h4>
<div class="paragraph">
<p>Use this procedure for a Foreman&#160;server connected to the Red&#160;Hat Content Delivery Network.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you customize configuration files, manually or using a tool such as Hiera, these changes are overwritten when the installation script runs during upgrading or updating. You can use the <code>--noop</code> option with the foreman-installer script to test for changes. For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in Foreman config files during an upgrade.</a>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Upgrade Foreman&#160;server</div>
<ol class="arabic">
<li>
<p>Create a backup.</p>
<div class="ulist">
<ul>
<li>
<p>On a virtual machine, take a snapshot.</p>
</li>
<li>
<p>On a physical machine, create a backup.</p>
<div class="paragraph">
<p>For more information about backups, see <a href="https://access.redhat.com/documentation/en-us/red_hat_satellite/6.8/html/administering_red_hat_satellite/backing-up-satellite-server-and-capsule-server">Backing Up Foreman&#160;server and Smart&#160;Proxy&#160;server</a> in the <em>Administering Foreman 6.8</em> guide.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration in the <code>/etc/zones.conf</code> or <code>/etc/dhcp/dhcpd.conf</code> files, back up the configuration files because the installer only supports one domain or subnet, and therefore restoring changes from these backups might be required.</p>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration files and do not want to overwrite the changes, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-installer} --foreman-proxy-dns-managed=false \
--foreman-proxy-dhcp-managed=false</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you use PostgreSQL as an external database, on the PostgreSQL server, install the <code>rh-postgresql12-postgresql-evr</code> package, which is available from the <code>{RepoRHEL7ServerForemanServerProductVersion}</code> repository:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install rh-postgresql12-postgresql-evr</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Discovered hosts</strong>. On the Discovered Hosts page, power off and then delete the discovered hosts. From the <strong>Select an Organization</strong> menu, select each organization in turn and repeat the process to power off and delete the discovered hosts. Make a note to reboot these hosts when the upgrade is complete.</p>
</li>
<li>
<p>Ensure that the Foreman Maintenance repository is enabled:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager repos --enable \
{RepoRHEL7ServerForemanMaintenanceProductVersion}</pre>
</div>
</div>
</li>
<li>
<p>Check the available versions to confirm the version you want is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-maintain} upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for upgrade. When prompted, enter the hammer admin user credentials to configure <code>foreman-maintain</code> with hammer credentials. These changes are applied to the <code>/etc/foreman-maintain/foreman-maintain-hammer.yml</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade check --target-version 6.8</pre>
</div>
</div>
<div class="paragraph">
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</div>
</li>
<li>
<p>Because of the lengthy upgrade time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running you can see the logged messages in the <code>/var/log/foreman-installer/satellite.log</code> file to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade run --target-version 6.8</pre>
</div>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, stop the <code>foreman-maintain</code> services and reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre># {foreman-maintain} service stop
# reboot</pre>
</div>
</div>
</li>
<li>
<p>If using a BASH shell, after a successful or failed upgrade, enter:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hash -d {foreman-maintain} service 2&gt; /dev/null</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration files, check and restore any changes required to the DNS and DHCP configuration files using the backups that you make.</p>
</li>
<li>
<p>If you make changes in the previous step, restart the <code>foreman-maintain</code> services.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-maintain} service restart</pre>
</div>
</div>
</li>
<li>
<p>If you have the OpenSCAP plug-in installed, but do not have the default OpenSCAP content available, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-rake foreman_openscap:bulk_upload:default</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="synchronizing_the_new_repositories">3.2. Synchronizing the New Repositories</h3>
<div class="paragraph">
<p>You must enable and synchronize the new 6.9-beta repositories before you can upgrade Smart&#160;Proxy&#160;servers and Foreman clients.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Content</strong> &gt; <strong>Red&#160;Hat Repositories</strong>.</p>
</li>
<li>
<p>Toggle the <strong>Recommended Repositories</strong> switch to the <strong>On</strong> position.</p>
</li>
<li>
<p>From the list of results, expand the following repositories and click the <strong>Enable</strong> icon to enable the repositories:</p>
<div class="ulist">
<ul>
<li>
<p>To upgrade Foreman clients, enable the <strong>Red&#160;Hat <a href="https://yum.theforeman.org/client/2.4/" class="bare">https://yum.theforeman.org/client/2.4/</a></strong> repositories for all Red&#160;Hat Enterprise Linux versions that clients use.</p>
</li>
<li>
<p>If you have Smart&#160;Proxy&#160;servers, to upgrade them, enable the following repositories too:</p>
<div class="paragraph">
<p><strong>Foreman Smart&#160;Proxy 6.9-beta (for RHEL 7 Server) (RPMs)</strong></p>
</div>
<div class="paragraph">
<p><strong>Foreman Maintenance 6 (for RHEL 7 Server) (RPMs)</strong></p>
</div>
<div class="paragraph">
<p><strong>Red&#160;Hat Ansible Engine {ForemanAnsibleVersion} RPMs for Red Hat Enterprise Linux 7 Server</strong></p>
</div>
<div class="paragraph">
<p><strong>Red&#160;Hat Software Collections RPMs for Red&#160;Hat Enterprise Linux 7 Server</strong></p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>If the 6.9-beta repositories are not available, refresh the Subscription Manifest. Navigate to <strong>Content</strong> &gt; <strong>Subscriptions</strong>, click <strong>Manage Manifest</strong>, then click <strong>Refresh</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Navigate to <strong>Content</strong> &gt; <strong>Sync Status</strong>.</p>
</li>
<li>
<p>Click the arrow next to the product to view the available repositories.</p>
</li>
<li>
<p>Select the repositories for 6.9-beta.</p>
</li>
<li>
<p>Click <strong>Synchronize Now</strong>.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>If an error occurs when you try to synchronize a repository, refresh the manifest. If the problem persists, raise a support request. Do not delete the manifest from the Customer Portal or in the Foreman web UI; this removes all the entitlements of your content hosts.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If you use Content Views to control updates to the base operating system of Smart&#160;Proxy&#160;server, update those Content Views with new repositories, publish, and promote their updated versions. For more information, see <a href="https://docs.theforeman.org/nightly/Content_Management_Guide/index-foreman-el.html#Managing_Content_Views">Managing Content Views</a> in the <em>Content Management Guide</em>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_capsule_server">3.3. Upgrading Smart&#160;Proxy&#160;servers</h3>
<div class="paragraph">
<p>This section describes how to upgrade Smart&#160;Proxy&#160;servers from 6.8 to 6.9-beta.</p>
</div>
<div class="ulist">
<div class="title">Before You Begin</div>
<ul>
<li>
<p>You must upgrade Foreman&#160;server before you can upgrade any Smart&#160;Proxy&#160;servers. Note that you can upgrade Smart&#160;Proxies separately from Foreman. For more information, see <a href="#upgrading_capsules-separately-from-satellite_upgrade-guide">Upgrading Smart&#160;Proxies Separately from Foreman</a>.</p>
</li>
<li>
<p>Ensure the Foreman Smart&#160;Proxy 6.9-beta repository is enabled in Foreman&#160;server and synchronized.</p>
</li>
<li>
<p>Ensure that you synchronize the required repositories on Foreman&#160;server. For more information, see <a href="#synchronizing_the_new_repositories">Synchronizing the New Repositories</a>.</p>
</li>
<li>
<p>If you use Content Views to control updates to the base operating system of Smart&#160;Proxy&#160;server, update those Content Views with new repositories and publish their updated versions. For more information, see <a href="https://docs.theforeman.org/nightly/Content_Management_Guide/index-foreman-el.html#Managing_Content_Views">Managing Content Views</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>Ensure the Smart&#160;Proxy&#8217;s base system is registered to the newly upgraded Foreman&#160;server.</p>
</li>
<li>
<p>Ensure the Smart&#160;Proxy has the correct organization and location settings in the newly upgraded Foreman&#160;server.</p>
</li>
<li>
<p>Review and update your firewall configuration prior to upgrading your Smart&#160;Proxy&#160;server. For more information, see <a href="https://docs.theforeman.org/nightly/Installing_Proxy_on_Red_Hat/index-foreman-el.html#preparing-environment-for-capsule-installation">Preparing Your Environment for Smart&#160;Proxy Installation</a> in <em>Installing Smart&#160;Proxy&#160;server</em>.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you implemented custom certificates, you must retain the content of both the <code>/root/ssl-build</code> directory and the directory in which you created any source files associated with your custom
certificates.</p>
</div>
<div class="paragraph">
<p>Failure to retain these files during an upgrade causes the upgrade to fail. If
these files have been deleted, they must be restored from a backup in order for
the upgrade to proceed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Upgrading Smart&#160;Proxy&#160;servers</div>
<ol class="arabic">
<li>
<p>Create a backup.</p>
<div class="ulist">
<ul>
<li>
<p>On a virtual machine, take a snapshot.</p>
</li>
<li>
<p>On a physical machine, create a backup.</p>
<div class="paragraph">
<p>For information on backups, see <a href="https://docs.theforeman.org/nightly/Administering_Red_Hat_Satellite/index-foreman-el.html#backing-up-satellite-server-and-capsule-server">Backing Up Foreman&#160;server and Smart&#160;Proxy&#160;server</a> in the <em>Administering Foreman 6.8</em> guide.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration in the <code>/etc/zones.conf</code> or <code>/etc/dhcp/dhcpd.conf</code> files, back up the configuration files because the installer only supports one domain or subnet, and therefore restoring changes from these backups might be required.</p>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration files and do not want to overwrite the changes, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-installer} --foreman-proxy-dns-managed=false \
--foreman-proxy-dhcp-managed=false</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, go to <strong>Hosts</strong> &gt; <strong>Discovered hosts</strong>. If there are discovered hosts available, power off the hosts and then delete all entries under the <code>Discovered hosts</code> page. Select all other organizations in turn using the organization setting menu and repeat this action as required. Reboot these hosts after the upgrade has completed.</p>
</li>
<li>
<p>Clean yum cache:</p>
<div class="listingblock">
<div class="content">
<pre># yum clean all</pre>
</div>
</div>
</li>
<li>
<p>Ensure that the <code>rubygem-foreman_maintain</code> package that provides <code>foreman-maintain</code> is installed and up to date:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install rubygem-foreman_maintain</pre>
</div>
</div>
</li>
<li>
<p>Update the <code>gofer</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum update gofer</pre>
</div>
</div>
</li>
<li>
<p>Restart the <code>goferd</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart goferd</pre>
</div>
</div>
</li>
<li>
<p>On Smart&#160;Proxy&#160;server, verify that the <code>foreman_url</code> setting points to the Foreman FQDN:</p>
<div class="listingblock">
<div class="content">
<pre># grep foreman_url /etc/foreman-proxy/settings.yml</pre>
</div>
</div>
</li>
<li>
<p>Check the available versions to confirm the version you want is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-maintain} upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Because of the lengthy upgrade time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running you can see the logged messages in the <code>/var/log/foreman-installer/satellite.log</code> file to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade check --target-version 6.8</pre>
</div>
</div>
<div class="paragraph">
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade run --target-version 6.8</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you run the command from a directory containing a <strong><em>config</em></strong> subdirectory, you will encounter the following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ERROR: Scenario (config/capsule.yaml) was not found, can not continue.</pre>
</div>
</div>
<div class="paragraph">
<p>In such a case, change directory, for example to the <strong><em>root</em></strong> user&#8217;s home directory, and run the command again.</p>
</div>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, stop the <code>foreman-maintain</code> services and reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre># {foreman-maintain} service stop
# reboot</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration files, check and restore any changes required to the DNS and DHCP configuration files using the backups made earlier.</p>
</li>
<li>
<p>Optional: If you use custom repositories, ensure that you enable these custom repositories after the upgrade completes.</p>
</li>
<li>
<p>Optional: If you plan to use Smart&#160;Proxy&#160;server as a proxy for discovered hosts, install the Discovery plug-in and turn on the hosts that were shut down prior to the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install tfm-rubygem-smart_proxy_discovery.noarch</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_clients">3.4. Upgrading Foreman Clients</h3>
<div class="paragraph">
<p>The <a href="https://yum.theforeman.org/client/2.4/" class="bare">https://yum.theforeman.org/client/2.4/</a> repository provides <code>katello-agent</code> and <code>katello-host-tools</code>, which provide communication services for managing Errata.</p>
</div>
<div class="paragraph">
<p>Note that the Katello agent is deprecated and will be removed in a future Foreman version. Migrate your workloads to use the remote execution feature to update clients remotely. For more information, see <a href="https://docs.theforeman.org/nightly/Managing_Hosts/index-foreman-el.html#host-management-without-goferd-and-katello-agent_managing-hosts">Host Management Without Goferd and Katello Agent</a> in the <em>Managing Hosts Guide</em>.</p>
</div>
<div class="paragraph">
<p>Currently, the Foreman 6.8 version of <code>katello-agent</code> and other client libraries in the <a href="https://yum.theforeman.org/client/2.4/" class="bare">https://yum.theforeman.org/client/2.4/</a> repository are not formally tested or supported against Foreman 6.9-beta.</p>
</div>
<div class="paragraph">
<p>For deployments using <code>katello-agent</code> and <strong>goferd</strong>, update all clients to the new version of <code>katello-agent</code>. For deployments not using <code>katello-agent</code> and <strong>goferd</strong>, update all clients to the new version of <code>katello-host-tools</code>. Complete this action as soon as possible so that your clients are fully compatible with Foreman&#160;server.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>You must have upgraded Foreman&#160;server.</p>
</li>
<li>
<p>You must have enabled the new <a href="https://yum.theforeman.org/client/2.4/" class="bare">https://yum.theforeman.org/client/2.4/</a> repositories on the Foreman.</p>
</li>
<li>
<p>You must have synchronized the new repositories in the Foreman.</p>
</li>
<li>
<p>If you have not previously installed <code>katello-agent</code> on your clients and you want to install, use the manual method. For more information, see <a href="#upgrading_clients_manually">Upgrade Foreman Clients Manually</a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you implemented custom certificates, you must retain the content of both the <code>/root/ssl-build</code> directory and the directory in which you created any source files associated with your custom
certificates.</p>
</div>
<div class="paragraph">
<p>Failure to retain these files during an upgrade causes the upgrade to fail. If
these files have been deleted, they must be restored from a backup in order for
the upgrade to proceed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Upgrade Foreman Clients Using the Bulk Repository Set UI:</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Content Hosts</strong> and select the Content Hosts that you want to upgrade.</p>
</li>
<li>
<p>From the <strong>Select Action</strong> list, select <strong>Manage Repository Sets</strong>.</p>
</li>
<li>
<p>From the <strong>Repository Sets Management</strong> list, select the <strong>Foreman Tools 6.8</strong> check box.</p>
</li>
<li>
<p>From the <strong>Select Action</strong> list, select <strong>Override to Disabled</strong>, and click <strong>Done</strong>.</p>
</li>
<li>
<p>When the process completes, on the same set of hosts from the previous steps, from the <strong>Select Action</strong> list <strong>Manage Repository Sets</strong>.</p>
</li>
<li>
<p>From the <strong>Repository Sets Management</strong> list, select the <strong>Red Hat <a href="https://yum.theforeman.org/client/2.4/" class="bare">https://yum.theforeman.org/client/2.4/</a></strong> check box.</p>
</li>
<li>
<p>From the <strong>Select Action</strong> list, select <strong>Override to Enabled</strong>, and click <strong>Done</strong>.</p>
</li>
<li>
<p>When the process completes, on the same set of hosts from the previous steps, from the <strong>Select Action</strong> list, select <strong>Manage Packages</strong>.</p>
</li>
<li>
<p>In the <strong>Package</strong> search field, enter one of the following options depending on your configuration:</p>
<div class="ulist">
<ul>
<li>
<p>If your deployment uses <code>katello-agent</code> and <strong>goferd</strong>, enter <code>katello-agent</code>.</p>
</li>
<li>
<p>If your deployment does not use <code>katello-agent</code> and <strong>goferd</strong>, enter <code>katello-host-tools</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Until <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1649764">BZ#1649764</a> is resolved, from the <strong>Update</strong> list, you must select <strong>via remote execution</strong>. This is required because if you update the package using the Katello agent, the package update disrupts the communication between the client and Foreman or Smart&#160;Proxy&#160;server, which causes the update to fail. For more information, see <a href="https://docs.theforeman.org/nightly/Managing_Hosts/index-foreman-el.html#configuring-and-setting-up-remote-jobs_managing-hosts">Configuring and Setting Up Remote Jobs</a> in the <em>Managing Hosts</em> guide.</p>
</li>
</ol>
</div>
<div id="upgrading_clients_manually" class="olist arabic">
<div class="title">Upgrade Foreman Clients Manually</div>
<ol class="arabic">
<li>
<p>Log into the client system.</p>
</li>
<li>
<p>Disable the repositories for the previous version of Foreman.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager repos \
--disable rhel-7-server-satellite-tools-6.8-rpms</pre>
</div>
</div>
</li>
<li>
<p>Enable the <a href="https://yum.theforeman.org/client/2.4/" class="bare">https://yum.theforeman.org/client/2.4/</a> repository for this version of Foreman.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager repos \
--enable=https://yum.theforeman.org/client/2.4/el7/x86_64/foreman-client-release.rpm</pre>
</div>
</div>
</li>
<li>
<p>Depending on your configuration, complete one of the following steps:</p>
<div class="ulist">
<ul>
<li>
<p>If your deployment uses <code>katello-agent</code> and <strong>goferd</strong>, enter the following command to install or upgrade <code>katello-agent</code>:</p>
<div class="listingblock">
<div class="content">
<pre># yum install katello-agent</pre>
</div>
</div>
</li>
<li>
<p>If your deployment does not use <code>katello-agent</code> and <strong>goferd</strong>, enter the following command to install or upgrade <code>katello-host-tools</code>:</p>
<div class="listingblock">
<div class="content">
<pre># yum install katello-host-tools</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_post_upgrade_tasks">4. Post-Upgrade Tasks</h2>
<div class="sectionbody">
<div id="post-upgrade_tasks" class="paragraph">
<p>Some of the procedures in this section are optional. You can choose to perform only those procedures that are relevant to your installation.</p>
</div>
<div class="paragraph">
<p>If you use the PXE-based discovery process, then you must complete the discovery upgrade procedure on Foreman and on any Smart&#160;Proxy&#160;server with hosts that you want to be listed in Foreman on the <strong>Hosts</strong> &gt; <strong>Discovered hosts</strong> page.</p>
</div>
<div class="sect2">
<h3 id="upgrading_discovery_parent">4.1. Upgrading Discovery</h3>
<div class="paragraph">
<p>This section describes updating the PXELinux template and the boot image passed to hosts that use PXE booting to register themselves with Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>From Foreman&#160;1.22, provisioning templates now have a separate association with a subnet, and do not default to using the TFTP Smart&#160;Proxy for that subnet. If you create subnets after the upgrade, you must specifically enable the Foreman or a Smart&#160;Proxy to provide a proxy service for discovery templates and then configure all subnets with discovered hosts to use a specific <em>template Smart&#160;Proxy</em>.</p>
</div>
<div class="paragraph">
<p>During the upgrade, for every subnet with a TFTP proxy enabled, the template Smart&#160;Proxy is set to be the same as the TFTP Smart&#160;Proxy. After the upgrade, check all subnets to verify this was set correctly.</p>
</div>
<div class="paragraph">
<p>These procedures are not required if you do not use PXE booting of hosts to enable Foreman to discover new hosts.</p>
</div>
<div class="sect3">
<h4 id="upgrading_discovery_satellite">4.1.1. Upgrading Discovery on Foreman&#160;server</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Update the Discovery template in the Foreman web UI:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>Provisioning templates</strong>.</p>
</li>
<li>
<p>On the <code>PXELinux global default</code> line, click <strong>Clone</strong>.</p>
</li>
<li>
<p>Enter a new name for the template in the <strong>Name</strong> field, for example <code>ACME PXE global default</code>.</p>
</li>
<li>
<p>In the template editor field, change the line <code>ONTIMEOUT local</code> to <code>ONTIMEOUT discovery</code> and click <strong>Submit</strong>.</p>
</li>
<li>
<p>Navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>.</p>
</li>
<li>
<p>Locate <code>Global default PXELinux template</code> and click on its <strong>Value</strong>.</p>
</li>
<li>
<p>Select the name of the newly created template from the menu and click the tick button.</p>
</li>
<li>
<p>Navigate to <strong>Hosts</strong> &gt; <strong>Provisioning templates</strong>.</p>
</li>
<li>
<p>Click <strong>Build PXE Default</strong>, then click <strong>OK</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>In the Foreman web UI, go to <strong>Configure</strong> &gt; <strong>Discovery Rules</strong> and associate selected organizations and locations with discovery rules.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="upgrading_discovery_capsule">4.1.2. Upgrading Discovery on Smart&#160;Proxy&#160;servers</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify that the Foreman Discovery package is current on Foreman&#160;server.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install tfm-rubygem-foreman_discovery</pre>
</div>
</div>
</li>
<li>
<p>If an update occurred in the previous step, restart the <code>foreman-maintain</code> services.</p>
<div class="listingblock">
<div class="content">
<pre># {foreman-maintain} service restart</pre>
</div>
</div>
</li>
<li>
<p>Upgrade the Discovery image on the Foreman Smart&#160;Proxy that is either connected to the provisioning network with discovered hosts or provides TFTP services for discovered hosts.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install foreman-discovery-image</pre>
</div>
</div>
</li>
<li>
<p>On the same instance, install the package which provides the Proxy service, and then restart <code>foreman-proxy</code> service.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install tfm-rubygem-smart_proxy_discovery
# service foreman-proxy restart</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, go to <strong>Infrastructure</strong> &gt; <strong>Smart&#160;Proxies</strong> and verify that the relevant Smart&#160;Proxy lists <strong>Discovery</strong> in the features column. Select <strong>Refresh</strong> from the <strong>Actions</strong> drop-down menu if necessary.</p>
</li>
<li>
<p>Go to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong> and for each subnet on which you want to use discovery:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Click the subnet name.</p>
</li>
<li>
<p>On the <strong>Smart&#160;Proxies</strong> tab, ensure the <strong>Discovery Smart&#160;Proxy</strong> is set to a Smart&#160;Proxy you configured above.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="verify_subnets_have_a_template_capsule">4.1.3. Verifying Subnets have a Template Smart&#160;Proxy</h4>
<div class="olist arabic">
<div class="title">Ensure all subnets with discovered hosts have a template Smart&#160;Proxy:</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong>.</p>
</li>
<li>
<p>Select the subnet you want to check.</p>
</li>
<li>
<p>On the <strong>Smart&#160;Proxies</strong> tab, ensure a <strong>Template Smart&#160;Proxy</strong> has been set for this subnet.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information about configuring subnets with template Smart&#160;Proxies, see <a href="https://docs.theforeman.org/nightly/Provisioning_Guide/index-foreman-el.html#configuring-the-discovery-service">Configuring the Discovery Service</a> in the <em>Provisioning Guide</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_virt_who">4.2. Upgrading virt-who</h3>
<div class="paragraph">
<p>If virt-who is installed on Foreman&#160;server or a Smart&#160;Proxy&#160;server, it will be upgraded when they are upgraded. No further action is required. If virt-who is installed elsewhere, it must be upgraded manually.</p>
</div>
<div class="paragraph">
<div class="title">Before You Begin</div>
<p>If virt-who is installed on a host registered to Foreman&#160;server or a Smart&#160;Proxy&#160;server, first upgrade the host to the latest packages available in the <a href="https://yum.theforeman.org/client/2.4/" class="bare">https://yum.theforeman.org/client/2.4/</a> repository. For information about upgrading hosts, see <a href="#upgrading_clients">Upgrading Foreman Clients</a>.</p>
</div>
<div class="olist arabic">
<div class="title">Upgrade virt-who Manually</div>
<ol class="arabic">
<li>
<p>Upgrade virt-who.</p>
<div class="listingblock">
<div class="content">
<pre># yum upgrade virt-who</pre>
</div>
</div>
</li>
<li>
<p>Restart the virt-who service so the new version is activated.</p>
<div class="listingblock">
<div class="content">
<pre># systemctl restart virt-who.service</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="removing_satellite_tools_repository">4.3. Removing the Previous Version of the Foreman Tools Repository</h3>
<div class="paragraph">
<p>After completing the upgrade to Foreman 6.9-beta, the Foreman Tools 6.8 repository can be removed from Content Views and then disabled.</p>
</div>
<div class="paragraph">
<p>Disable Version 6.8 of the Foreman Tools Repository:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Content</strong> &gt; <strong>Red Hat Repositories</strong>.</p>
</li>
<li>
<p>In the <strong>Enabled Repositories</strong> area, locate <strong>Foreman Tools 6.8 for RHEL 7 Server RPMs x86_64</strong>.</p>
</li>
<li>
<p>Click the <strong>Disable</strong> icon to the right.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the repository is still contained in a Content View then you cannot disable it. Packages from a disabled repository are removed automatically by a scheduled task.</p>
</div>
</div>
<div class="sect2">
<h3 id="reclaiming-mongodb-space_upgrade-guide">4.4. Reclaiming MongoDB Space</h3>
<div class="paragraph">
<p>The MongoDB database can use a large amount of disk space especially in heavily loaded deployments.
Use this procedure to reclaim some of this disk space on Foreman.</p>
</div>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Back up the MongoDB database.
For more information about backing up Foreman, see <a href="https://docs.theforeman.org/nightly/Administering_Red_Hat_Satellite/index-foreman-el.html#backing-up-satellite-server-and-capsule-server">Backing Up Foreman&#160;server and Smart&#160;Proxy&#160;server</a>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Stop Pulp services:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain service stop --only \
pulp_celerybeat.service,pulp_resource_manager.service,pulp_streamer.service,pulp_workers.service,httpd</pre>
</div>
</div>
</li>
<li>
<p>Access the MongoDB shell:</p>
<div class="listingblock">
<div class="content">
<pre># mongo pulp_database</pre>
</div>
</div>
</li>
<li>
<p>Check the amount of disk space used by MongoDB before a repair:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; db.stats()</pre>
</div>
</div>
</li>
<li>
<p>Ensure that you have free disk space equal to the size of your current MongoDB database plus 2 GB.
If the volume containing the MongoDB database lacks sufficient space, you can mount a separate volume and use that for the repair.</p>
</li>
<li>
<p>Enter the repair command.
Note that the repair command blocks all other operations and can take a long time to complete, depending on the size of the database.</p>
<div class="listingblock">
<div class="content">
<pre>&gt; db.repairDatabase()</pre>
</div>
</div>
</li>
<li>
<p>Check the amount of disk space used by MongoDB after a repair:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; db.stats()</pre>
</div>
</div>
</li>
<li>
<p>Exit the MongoDB shell:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; exit</pre>
</div>
</div>
</li>
<li>
<p>Start Pulp services:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain service start</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="reclaiming-postgresql-space-after-an-upgrade_upgrade-guide">4.5. Reclaiming PostgreSQL Space</h3>
<div class="paragraph">
<p>The PostgreSQL database can use a large amount of disk space especially in heavily loaded deployments.
Use this procedure to reclaim some of this disk space on Foreman.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Stop all services, except for the <code>postgresql</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain service stop --exclude postgresql</pre>
</div>
</div>
</li>
<li>
<p>Switch to the <code>postgres</code> user and reclaim space on the database:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># su - postgres -c 'vacuumdb --full --dbname=foreman'</pre>
</div>
</div>
</li>
<li>
<p>Start the other services when the vacuum completes:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain service start</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_the_mongodb_storage_engine">4.6. Upgrading the MongoDB Storage Engine</h3>
<div class="paragraph">
<p>When you complete the upgrade, you can optionally upgrade the MongoDB storage engine to WiredTiger. Note that if you already use WiredTiger, you do not have to perform this procedure after you upgrade. If you want to use WiredTiger, you must repeat the following procedure on Foreman&#160;server and all Smart&#160;Proxy&#160;servers. For more information about the WiredTiger storage engine, see <a href="https://docs.mongodb.com/manual/core/wiredtiger/">WiredTiger Storage Engine</a> in the <em>MongoDB Manual</em>.</p>
</div>
<div class="paragraph">
<div class="title">Prerequisites</div>
<p>Before upgrading the storage engine, ensure that the following conditions exist:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a backup of the MongoDB storage.</p>
</li>
<li>
<p>Ensure that the <code>/var/tmp</code> directory has storage space that is at least twice the size of the <code>/var/lib/mongodb</code> directory.</p>
</li>
<li>
<p>Optional: On high traffic Foreman environments, use MongoDB repair to reclaim disk space. For more information, see the KCS article <a href="https://access.redhat.com/solutions/3052771">How to compact MongoDB files and/or reclaim disk space in "/var/lib/mongodb" in Foreman?</a>.</p>
</li>
<li>
<p>Optional: On high traffic Foreman environments, use MongoDB compact to reclaim disk space. For more information, see <a href="https://docs.mongodb.com/manual/reference/command/compact/">compact</a> in MongoDB Manual.</p>
</li>
<li>
<p>Optional: If you want to verify what version of MongoDB you currently use, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre># mongo pulp_database --eval "db.serverStatus().storageEngine"</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">Procedure</div>
<p>To upgrade the MongoDB storage engine, enter the following command on Foreman&#160;server and all Smart&#160;Proxy&#160;servers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># {foreman-installer} --upgrade-mongo-storage-engine</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="post_upgrade-updating-templates-parameters">4.7. Updating Templates, Parameters, Lookup Keys and Values</h3>
<div class="paragraph">
<p>During the upgrade process, Foreman attempts to locate macros that are deprecated for Foreman 6.9-beta and converts old syntax to new syntax for the default {Product} templates, parameters, and lookup keys and values. However, {Product} does not convert old syntax in the custom templates that you have created and in the cloned templates.</p>
</div>
<div class="paragraph">
<p>The process uses simple text replacement, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@host.params['parameter1'] -&gt; host_param('parameter1')
@host.param_true?('parameter1') -&gt; host_param_true?('parameter1')
@host.param_false?('parameter1') -&gt; host_param_false?('parameter1')
@host.info['parameters'] -&gt; host_enc['parameters']</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you use cloned templates in Foreman, verify whether the cloned templates have diverged from the latest version of the original templates in Foreman. The syntax for the same template can differ between versions of Foreman. If your cloned templates contain outdated syntax, update the syntax to match the latest version of the template.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To ensure that this text replacement does not break or omit any variables in your files during the upgrade, check all templates, parameters, and lookup keys and values for the old syntax and replace manually.</p>
</div>
<div class="paragraph">
<p>The following error occurs because of old syntax remaining in files after the upgrade:</p>
</div>
<div class="listingblock">
<div class="content">
<pre> undefined method '#params' for Host::Managed::Jail</pre>
</div>
</div>
<div class="paragraph">
<div class="title">Fixing the outdated subscription_manager_registration snippet</div>
<p>Foreman 6.4 onwards uses the <code>redhat_register</code> snippet instead of the <code>subscription_manager_registration</code> snippet.</p>
</div>
<div class="paragraph">
<p>If you upgrade from Foreman 6.3 and earlier, ensure to replace the <code>subscription_manager_registration</code> snippet in your custom templates as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;%= snippet "subscription_manager_registration" %&gt;
               ↓
&lt;%= snippet 'redhat_register' %&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tuning-with-predefined-profiles_upgrade-guide">4.8. Tuning Foreman&#160;server with Predefined Profiles</h3>
<div class="paragraph">
<p>If your Foreman deployment includes more than 5000 hosts, you can use predefined tuning profiles to improve performance of Foreman.</p>
</div>
<div class="paragraph">
<p>Note that you cannot use tuning profiles on Smart&#160;Proxies.</p>
</div>
<div class="paragraph">
<p>You can choose one of the profiles depending on the number of hosts your Foreman manages and available hardware resources.</p>
</div>
<div class="paragraph">
<p>The tuning profiles are available in the <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/sizes</code> directory.</p>
</div>
<div class="paragraph">
<p>When you run the <code>foreman-installer</code> command with the <code>--tuning</code> option, deployment configuration settings are applied to Foreman in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The default tuning profile defined in the <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/common.yaml</code> file</p>
</li>
<li>
<p>The tuning profile that you want to apply to your deployment and is defined in the <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/sizes/</code> directory</p>
</li>
<li>
<p>Optional: If you have configured a <code>/etc/foreman-installer/custom-hiera.yaml</code> file, Foreman applies these configuration settings.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note that the configuration settings that are defined in the <code>/etc/foreman-installer/custom-hiera.yaml</code> file override the configuration settings that are defined in the tuning profiles.</p>
</div>
<div class="paragraph">
<p>Therefore, before applying a tuning profile, you must compare the configuration settings that are defined in the default tuning profile in <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/common.yaml</code>, the tuning profile that you want to apply and your <code>/etc/foreman-installer/custom-hiera.yaml</code> file, and remove any duplicated configuration from the <code>/etc/foreman-installer/custom-hiera.yaml</code> file.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">default</dt>
<dd>
<p>Number of managed hosts: 0-5000</p>
<div class="paragraph">
<p>RAM: 20G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 4</p>
</div>
</dd>
<dt class="hdlist1">medium</dt>
<dd>
<p>Number of managed hosts: 5001-10000</p>
<div class="paragraph">
<p>RAM: 32G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 8</p>
</div>
</dd>
<dt class="hdlist1">large</dt>
<dd>
<p>Number of managed hosts: 10001-20000</p>
<div class="paragraph">
<p>RAM: 64G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 16</p>
</div>
</dd>
<dt class="hdlist1">extra-large</dt>
<dd>
<p>Number of managed hosts: 20001-60000</p>
<div class="paragraph">
<p>RAM: 128G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 32</p>
</div>
</dd>
<dt class="hdlist1">extra-extra-large</dt>
<dd>
<p>Number of managed hosts: 60000+</p>
<div class="paragraph">
<p>RAM: 256G</p>
</div>
<div class="paragraph">
<p>Number of CPU cores: 48+</p>
</div>
</dd>
</dl>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Optional: If you have configured the <code>custom-hiera.yaml</code> file on Foreman&#160;server, back up the <code>/etc/foreman-installer/custom-hiera.yaml</code> file to <code>custom-hiera.original</code>.
You can use the backup file to restore the <code>/etc/foreman-installer/custom-hiera.yaml</code> file to its original state if it becomes corrupted:</p>
<div class="listingblock">
<div class="content">
<pre># cp /etc/foreman-installer/custom-hiera.yaml \
/etc/foreman-installer/custom-hiera.original</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you have configured the <code>custom-hiera.yaml</code> file on Foreman&#160;server, review the definitions of the default tuning profile in <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/common.yaml</code> and the tuning profile that you want to apply in <code>/usr/share/foreman-installer/config/foreman.hiera/tuning/sizes/</code>.
Compare the configuration entries against the entries in your <code>/etc/foreman-installer/custom-hiera.yaml</code> file and remove any duplicated configuration settings in your <code>/etc/foreman-installer/custom-hiera.yaml</code> file.</p>
</li>
<li>
<p>Enter the <code>foreman-installer</code> command with the <code>--tuning</code> option for the profile that you want to apply.
For example, to apply the medium tuning profile settings, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --tuning medium</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_updating_satellite_server_capsule_server_and_content_hosts">5. Updating Satellite Server, Capsule Server, and Content Hosts</h2>
<div class="sectionbody">
<div id="introduction_updating_satellite" class="paragraph">
<p>Use this chapter to update your existing Foreman&#160;server, Smart&#160;Proxy&#160;server, and Content Hosts to a new minor version, for example, from 6.9-beta.0 to 6.9-beta.1.</p>
</div>
<div class="paragraph">
<p>Updates patch security vulnerabilities and minor issues discovered after code is released, and are often fast and non-disruptive to your operating environment.</p>
</div>
<div class="paragraph">
<p>Before updating, back up your Foreman&#160;server and all Smart&#160;Proxy&#160;servers. For more information, see <a href="https://docs.theforeman.org/nightly/Administering_Red_Hat_Satellite/index-foreman-el.html#backing-up-satellite-server-and-capsule-server">Backing Up Foreman&#160;server and Smart&#160;Proxy&#160;server</a> in the <em>Administering Foreman</em> guide.</p>
</div>
<div class="sect2">
<h3 id="updating_satellite_server_to_next_minor_version">5.1. Updating Foreman&#160;server</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Ensure that you have synchronized Foreman&#160;server repositories for
Foreman, Smart&#160;Proxy, and <a href="https://yum.theforeman.org/client/2.4/" class="bare">https://yum.theforeman.org/client/2.4/</a>.</p>
</li>
<li>
<p>Ensure each external Smart&#160;Proxy and Content Host can be updated by
promoting the updated repositories to all relevant Content Views.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you customize configuration files, manually or use a tool such as Hiera, these customizations are overwritten when the installation script runs during upgrading or updating. You can use the <code>--noop</code> option with the foreman-installer script to test for changes. For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in Foreman config files during an upgrade</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Updating Foreman&#160;server to the Next Minor Version</strong></p>
</div>
<div class="olist arabic">
<div class="title">To Update Foreman&#160;server:</div>
<ol class="arabic">
<li>
<p>Ensure the Foreman Maintenance repository is enabled:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager repos --enable \
{RepoRHEL7ServerForemanMaintenanceProductVersion}</pre>
</div>
</div>
</li>
<li>
<p>Check the available versions to confirm the next minor version is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-maintain} upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for upgrade. On first use of this command, <code>foreman-maintain</code> prompts you to enter the hammer admin user credentials and saves them in the <code>/etc/foreman-maintain/foreman-maintain-hammer.yml</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade check --target-version 6.8.<em>z</em></pre>
</div>
</div>
<div class="paragraph">
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</div>
</li>
<li>
<p>Because of the lengthy update time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running, you can see the logged messages in the <code>/var/log/foreman-installer/satellite.log</code> file to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade run --target-version 6.8.<em>z</em></pre>
</div>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, stop the <code>foreman-maintain</code> services and reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre># {foreman-maintain} service stop
# reboot</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_updating_disconnected_foremanserver">5.2. Updating Disconnected Foreman&#160;server</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Before syncing the following repositories, set the download policy to <strong>Immediate</strong>. This is required because Foreman downloads all packages only during synchronization of repositories with the immediate download policy.</p>
</li>
<li>
<p>Ensure that you have synchronized the following Foreman&#160;server repositories for Foreman, Smart&#160;Proxy, and <a href="https://yum.theforeman.org/client/2.4/" class="bare">https://yum.theforeman.org/client/2.4/</a>:</p>
<div class="ulist">
<ul>
<li>
<p>rhel-7-server-rpms</p>
</li>
<li>
<p>rhel-7-server-satellite-6.8-rpms</p>
</li>
<li>
<p>rhel-7-server-satellite-maintenance-6-rpms</p>
</li>
<li>
<p>rhel-server-rhscl-7-rpms</p>
</li>
<li>
<p>rhel-7-server-ansible-2.9-rpms</p>
<div class="paragraph">
<p>For more information about configuring download policies, see <a href="https://docs.theforeman.org/nightly/Content_Management_Guide/index-foreman-el.html#changing_the_download_policy_for_a_repository">Changing a download policy for a repository</a> in the <em>Content Management guide</em>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Ensure no Red Hat repositories are enabled by entering the command:</p>
<div class="listingblock">
<div class="content">
<pre># yum repolist</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Updating Disconnected Foreman&#160;server to the Next Minor Version</div>
<ol class="arabic">
<li>
<p>Create a new configuration file as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># vi /etc/yum.repos.d/redhat-local.repo

[rhel-7-server-ansible-2.9-rpms]
name=Ansible {ForemanAnsibleVersion} RPMs for Red Hat Enterprise Linux 7 Server x86_64
baseurl=file:///var/lib/pulp/published/yum/https/repos/Default_Organization/Library/content/dist/rhel/server/7/7Server/x86_64/ansible/2.9/os/
enabled=1

[rhel-7-server-rpms]
name=Red Hat Enterprise Linux 7 Server RPMs x86_64
baseurl=file:///var/lib/pulp/published/yum/https/repos/Default_Organization/Library/content/dist/rhel/server/7/7Server/x86_64/os/
enabled=1

[{RepoRHEL7ServerForemanServerProductVersion}]
name=Foreman for RHEL 7 Server RPMs x86_64
baseurl=file:///var/lib/pulp/published/yum/https/repos/Default_Organization/Library/content/dist/rhel/server/7/7Server/x86_64/satellite/6.9-beta/os/
enabled=1

[{RepoRHEL7ServerForemanMaintenanceProductVersion}]
name=Foreman Maintenance 6 for RHEL 7 Server RPMs x86_64
baseurl=file:///var/lib/pulp/published/yum/https/repos/Default_Organization/Library/content/dist/rhel/server/7/7Server/x86_64/sat-maintenance/6/os/
enabled=1

[rhel-server-rhscl-7-rpms]
name=Red Hat Software Collections RPMs for Red Hat Enterprise Linux 7 Server x86_64
baseurl=file:///var/lib/pulp/published/yum/https/repos/Default_Organization/Library/content/dist/rhel/server/7/7Server/x86_64/rhscl/1/os/
enabled=1</pre>
</div>
</div>
</li>
<li>
<p>In the configuration file, replace <code>Default_Organization</code> in the <code>baseurl</code> with the correct organization label.
To obtain the organization label, enter the command:</p>
<div class="listingblock">
<div class="content">
<pre># ls /var/lib/pulp/published/yum/https/repos/</pre>
</div>
</div>
</li>
<li>
<p>Ensure that the <code>rubygem-foreman_maintain</code> package that provides <code>foreman-maintain</code> is installed and up to date:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install rubygem-foreman_maintain</pre>
</div>
</div>
</li>
<li>
<p>Check the available versions to confirm the next minor version is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-maintain} upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for the upgrade. On the first use of this command, <code>foreman-maintain</code> prompts you to enter the hammer admin user credentials and saves them in the <code>/etc/foreman-maintain/foreman-maintain-hammer.yml</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade check --target-version 6.9-beta.<em>z</em></pre>
</div>
</div>
<div class="paragraph">
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</div>
</li>
<li>
<p>Because of the lengthy update time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running, you can see the logged messages in the <code>/var/log/foreman-installer/satellite.log</code> file to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade run --target-version 6.9-beta.<em>z</em></pre>
</div>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, stop the <code>foreman-maintain</code> services and reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre># {foreman-maintain} service stop
# reboot</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="updating_capsule_server_to_next_minor_version">5.3. Updating Smart&#160;Proxy&#160;server</h3>
<div class="paragraph">
<p>Use this procedure to update Smart&#160;Proxy&#160;servers to the next minor version.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Update the <code>gofer</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># yum install gofer</pre>
</div>
</div>
</li>
<li>
<p>Restart the <code>goferd</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart goferd</pre>
</div>
</div>
</li>
<li>
<p>Ensure that the Foreman Maintenance repository is enabled:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager repos --enable \
{RepoRHEL7ServerForemanMaintenanceProductVersion}</pre>
</div>
</div>
</li>
<li>
<p>Check the available versions to confirm the next minor version is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># {foreman-maintain} upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade check --target-version 6.8.<em>z</em></pre>
</div>
</div>
<div class="paragraph">
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</div>
</li>
<li>
<p>Because of the lengthy update time, use a utility such as <code>screen</code> to suspend and reattach a communication session. You can then check the upgrade progress without staying connected to the command shell continuously. For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running, you can see the logged messages in the <code>/var/log/foreman-installer/satellite.log</code> file to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade run --target-version 6.8.<em>z</em></pre>
</div>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, stop the <code>foreman-maintain</code> services and reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre># {foreman-maintain} service stop
# reboot</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="updating_content_hosts_to_next_minor_version">5.4. Updating Content Hosts</h3>
<div class="paragraph">
<p><strong>Updating Content Hosts to the Next Minor Version</strong></p>
</div>
<div class="olist arabic">
<div class="title">To Update a Content Host, enter the following commands:</div>
<ol class="arabic">
<li>
<p>Until <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1649764">BZ#1649764</a> is resolved, update the <code>gofer</code> package:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">yum update gofer</pre>
</div>
</div>
</li>
<li>
<p>Restart <strong>goferd</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># systemctl restart goferd</pre>
</div>
</div>
</li>
<li>
<p>Update all packages:</p>
<div class="listingblock">
<div class="content">
<pre># yum update</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre># reboot</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated Mar 2021
</div>
</div>
</body>
</html>