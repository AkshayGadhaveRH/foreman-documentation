<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Upgrading and Updating Foreman</title>
<link rel="stylesheet" href="./foreman-deb.css">
<!-- docinfo -->
</head>
<body class="book toc2 toc-left">
<!--
	vim: set noai ts=2 sts=2 sw=2 et ft= syn=html
-->
<div id="wrap">
<script src="/js/nav.js"></script>
<script>
const versionRe = new RegExp(`/(nightly|\\d+.\\d+)/`);
var currentVer = document.location.toString().match(versionRe);
if (currentVer && currentVer.length > 1) {
  currentVer = currentVer[1];
} else {
  currentVer = "nightly";
}
var navId = 1;
var Navbar = `<nav>
<img class="logo" src="/img/helmet.svg" />
<button type="button" class="btn-hamburger" data-action="nav-toggle">
  <span></span>
  <span></span>
  <span></span>
  <span></span>
  <span></span>
</button>
<ul class="nav-menu">
  <li class="nav-item"><a href="/">Home</a></li>`
  + navItems.map(function(navItem){ return(
    `<li id="nav-id-`+ navId++ +`" class="nav-item dropdown">
        <a href="#" data-action="dropdown-toggle">`+ navItem.title + `</a>
        <div class="dropdown-menu">`
        + navItem.items.map(function(item){ return(
            `<div class="dropdown-div"><a class="dropdown-item" href=/`+currentVer+item.href+`>`+item.title+`</a></div>`
        )}).join("")
        +`</div>
    </li>`
    )}).join("")
  + navVersions.map(function(navItem){ return(
    `<li id="nav-id-`+ navId++ +`" class="nav-item dropdown">
        <a href="#" data-action="dropdown-toggle">Version `+currentVer+`</a>
        <div class="dropdown-menu dropdown-menu-left">`
        + navItem.items.map(function(item){
            if (document.location.pathname == "/") {
                var dl = "/release/" + item.href;
            } else {
                var dl = document.location.toString().replace(versionRe, "/"+item.href+"/");
            }
            return(`<div class="dropdown-div"><a class="dropdown-item" href=`+dl+`>`+item.title+`</a></div>`
        )}).join("")
        +`</div>
    </li>`
    )}).join("")
+`</ul>
</nav>`;

function toggleElement(dropdown) {
  if (dropdown.classList.contains("show")) {
    dropdown.classList.remove("show");
  } else {
    dropdown.classList.add("show");
  }
}

function closeAll(except) {
  for (let i = 1; i <= navItems.length + 1; i++) {
    let elem = document.getElementById("nav-id-" + i)
    if (elem != except) {
      elem.classList.remove("show");
    }
  }
}

var addNavbarListeners = () => {
  let nav = document.querySelector("nav");
  let navId = 1;
  nav.querySelectorAll("[data-action='dropdown-toggle']").forEach((dropdownToggle) => {
    let dropdown = document.getElementById("nav-id-" + navId++);
    dropdownToggle.addEventListener("click", () => {
      closeAll(dropdown);
      toggleElement(dropdown);
    });
  });

  nav.querySelector("[data-action='nav-toggle']").addEventListener("click", () => {
    if (nav.classList.contains("opened")) {
      nav.classList.remove("opened");
    } else {
      nav.classList.add("opened");
    }
  });
}
document.open();
document.write(Navbar)
addNavbarListeners();
document.close();
</script>
</div>
<div id="header">
<h1>Upgrading and Updating Foreman</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#upgrading_process_overview">1. Upgrade Overview</a>
<ul class="sectlevel2">
<li><a href="#upgrading_prerequisites">1.1. Prerequisites</a></li>
<li><a href="#upgrade_paths">1.2. Upgrade Paths</a></li>
<li><a href="#following_the_progress_of_the_upgrade">1.3. Following the Progress of the Upgrade</a></li>
<li><a href="#Upgrading_Proxies_Separately_from_Server_upgrade-guide">1.4. Upgrading Smart&#160;Proxies Separately from Foreman</a></li>
</ul>
</li>
<li><a href="#_upgrading_foreman">2. Upgrading Foreman</a>
<ul class="sectlevel2">
<li><a href="#Upgrading_Server_upgrade-guide">2.1. Upgrading Foreman&#160;server</a></li>
<li><a href="#upgrading_capsule_server">2.2. Upgrading Smart&#160;Proxy&#160;servers</a></li>
<li><a href="#upgrading_discovery_parent">2.3. Upgrading Discovery</a></li>
<li><a href="#reclaiming-postgresql-space-after-an-upgrade_upgrade-guide">2.4. Reclaiming PostgreSQL Space</a></li>
<li><a href="#updating_satellite_server_to_next_minor_version">2.5. Updating Foreman&#160;server</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="upgrading_process_overview"><a class="anchor" href="#upgrading_process_overview"></a>1. Upgrade Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter details the prerequisites and available upgrade paths to Foreman nightly.
Review this information before upgrading your current Foreman installation.</p>
</div>
<div class="paragraph">
<p>In this guide, the terms update, upgrade, and migrate have the following meanings:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Upgrading</dt>
<dd>
<p>The process of advancing your Foreman&#160;server and Smart&#160;Proxy&#160;server installations from a y-stream release to the next, for example Foreman 3.1 to Foreman nightly.</p>
</dd>
<dt class="hdlist1">Updating</dt>
<dd>
<p>The process of advancing your Foreman&#160;server and Smart&#160;Proxy&#160;server installations from a z-stream release to the next, for example Foreman nightly.0 to Foreman nightly.1.</p>
</dd>
<dt class="hdlist1">Migrating</dt>
<dd>
<p>The process of moving an existing Foreman installation to another Red&#160;Hat Enterprise&#160;Linux server.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Note that you can upgrade Smart&#160;Proxies separately from Foreman.
For more information, see <a href="#Upgrading_Proxies_Separately_from_Server_upgrade-guide">Upgrading Smart&#160;Proxies Separately from Foreman</a>.</p>
</div>
<div class="sect2">
<h3 id="upgrading_prerequisites"><a class="anchor" href="#upgrading_prerequisites"></a>1.1. Prerequisites</h3>
<div class="paragraph">
<p>Upgrading to Foreman nightly affects your entire Foreman infrastructure.
Before proceeding, complete the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read the Foreman nightly <a href="https://docs.theforeman.org/nightly/Release_notes/index-foreman-deb.html#">Release Notes</a>.</p>
</li>
<li>
<p>Review this guide so that you are aware of the upgrade process and its impact.</p>
</li>
<li>
<p>Plan your upgrade path.
For more information, see <a href="#upgrade_paths">Upgrade Paths</a>.</p>
</li>
<li>
<p>Plan for the required downtime. Foreman services are shut down during the upgrade.
The upgrade process duration might vary depending on your hardware configuration, network speed, and the amount of data that is stored on the server.</p>
<div class="paragraph">
<p>Upgrading Foreman takes approximately 1 - 2 hours.</p>
</div>
<div class="paragraph">
<p>Upgrading Smart&#160;Proxy takes approximately 10 - 30 minutes.</p>
</div>
</li>
<li>
<p>Ensure that you have sufficient storage space on your server.
For more information, see <a href="https://docs.theforeman.org/nightly/Installing_Server_on_Debian/index-foreman-deb.html#Preparing_your_Environment_for_Installation_foreman">Preparing your Environment for Installation</a> in <em>Installing Foreman&#160;server from a Connected Network</em> and <a href="https://docs.theforeman.org/nightly/Installing_Proxy_on_Debian/index-foreman-deb.html#preparing-environment-for-capsule-installation">Preparing your Environment for Installation</a> in <em>Installing Smart&#160;Proxy&#160;server</em>.</p>
</li>
<li>
<p>Back up your Foreman&#160;server and all Smart&#160;Proxy&#160;servers.
For more information, see <a href="https://docs.theforeman.org/nightly/Administering_Red_Hat_Satellite/index-foreman-deb.html#Backing_Up_Server_and_Proxy_admin">Backing Up Foreman&#160;server and Smart&#160;Proxy&#160;server</a> in the <em>Administering Foreman</em> guide.</p>
</li>
<li>
<p>Plan for updating any scripts you use that contain Foreman API commands because some API commands differ between versions of Foreman.
For more information about changes in the API, see the Red Hat Knowledgebase article <a href="https://access.redhat.com/articles/4396911">API Changes Between Foreman Versions</a> on the Red&#160;Hat Customer Portal.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you customize configuration files, manually or use a tool such as Hiera, these customizations are overwritten when the installation script runs during upgrading or updating.
You can use the <code>--noop</code> option with the foreman-installer script to test for changes.
For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in Foreman config files during an upgrade.</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="upgrade_paths"><a class="anchor" href="#upgrade_paths"></a>1.2. Upgrade Paths</h3>
<div class="paragraph">
<p>You can upgrade to Foreman nightly from Foreman 3.1.
Foreman&#160;servers and Smart&#160;Proxy&#160;servers on earlier versions must first be upgraded to Foreman 3.1.
For more information, see the Foreman 3.1 Upgrade documentation.</p>
</div>
<div class="paragraph">
<div class="title">Overview of Foreman nightly Upgrade Paths</div>
<p>The high level steps in upgrading to Foreman nightly are as follows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Upgrade Foreman&#160;server to nightly.
For more information, see <a href="#Upgrading_Server_upgrade-guide">Upgrading Foreman&#160;server</a>.</p>
</li>
<li>
<p>Upgrade all Smart&#160;Proxy&#160;servers to nightly. For more information, see <a href="#upgrading_capsule_server">Upgrading Smart&#160;Proxy&#160;servers</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="following_the_progress_of_the_upgrade"><a class="anchor" href="#following_the_progress_of_the_upgrade"></a>1.3. Following the Progress of the Upgrade</h3>
<div class="paragraph">
<p>Because of the lengthy upgrade time, use a utility such as <code>screen</code> to suspend and reattach a communication session.
You can then check the upgrade progress without staying connected to the command shell continuously.
For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.
For more information, see the <code>screen</code> manual page.</p>
</div>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running you can see the logs in <code>/var/log/foreman-installer/foreman.log</code> to check if the process completed successfully.</p>
</div>
</div>
<div class="sect2">
<h3 id="Upgrading_Proxies_Separately_from_Server_upgrade-guide"><a class="anchor" href="#Upgrading_Proxies_Separately_from_Server_upgrade-guide"></a>1.4. Upgrading Smart&#160;Proxies Separately from Foreman</h3>
<div class="paragraph">
<p>You can upgrade Foreman to version nightly and keep Smart&#160;Proxies at version 3.1 until you have the capacity to upgrade them too.</p>
</div>
<div class="paragraph">
<p>All the functionality that worked previously works on 3.1 Smart&#160;Proxies.
However, the functionality added in the nightly release will not work until you upgrade Smart&#160;Proxies to nightly.</p>
</div>
<div class="paragraph">
<p>Upgrading Smart&#160;Proxies after upgrading Foreman can be useful in the following example scenarios:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you want to have several smaller outage windows instead of one larger window.</p>
</li>
<li>
<p>If Smart&#160;Proxies in your organization are managed by several teams and are located in different locations.</p>
</li>
<li>
<p>If you use a load-balanced configuration, you can upgrade one load-balanced Smart&#160;Proxy and keep other load-balanced Smart&#160;Proxies at one version lower.
This allows you to upgrade all Smart&#160;Proxies one after another without any outage.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upgrading_foreman"><a class="anchor" href="#_upgrading_foreman"></a>2. Upgrading Foreman</h2>
<div class="sectionbody">
<div id="introduction_upgrading_satellite" class="paragraph">
<p>Use the following procedures to upgrade your existing Foreman to Foreman nightly:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#Upgrading_Server_upgrade-guide">Upgrading Foreman&#160;server</a></p>
</li>
<li>
<p><a href="#upgrading_capsule_server">Upgrading Smart&#160;Proxy&#160;servers</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Before upgrading, see <a href="#upgrading_prerequisites">Prerequisites</a>.</p>
</div>
<div class="sect2">
<h3 id="Upgrading_Server_upgrade-guide"><a class="anchor" href="#Upgrading_Server_upgrade-guide"></a>2.1. Upgrading Foreman&#160;server</h3>
<div class="paragraph">
<p>This section describes how to upgrade Foreman&#160;server from 3.1 to nightly.
You can upgrade from any minor version of Foreman&#160;server 3.1.</p>
</div>
<div id="upgrading_satellite_server_prerequisites" class="ulist">
<div class="title">Before You Begin</div>
<ul>
<li>
<p>Note that you can upgrade Smart&#160;Proxies separately from Foreman.
For more information, see <a href="#Upgrading_Proxies_Separately_from_Server_upgrade-guide">Upgrading Smart&#160;Proxies Separately from Foreman</a>.</p>
</li>
<li>
<p>Review and update your firewall configuration prior to upgrading your Foreman&#160;server.
For more information, see <a href="https://docs.theforeman.org/nightly/Installing_Server_on_Debian/index-foreman-deb.html#Preparing_your_Environment_for_Installation_foreman">Preparing your environment for installation</a> in <em>Installing Foreman&#160;server</em>.</p>
</li>
<li>
<p>Back up and remove all Foreman hooks before upgrading.
Restore any hooks only after Foreman is known to be working after the upgrade is complete.</p>
</li>
<li>
<p>If you have edited any of the default templates, back up the files either by cloning or exporting them.
Cloning is the recommended method because that prevents them being overwritten in future updates or upgrades.
To confirm if a template has been edited, you can view its <strong>History</strong> before you upgrade or view the changes in the audit log after an upgrade.
In the Foreman web UI, navigate to <strong>Monitor</strong> &gt; <strong>Audits</strong> and search for the template to see a record of changes made.
If you use the export method, restore your changes by comparing the exported template and the default template, manually applying your changes.</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Smart&#160;Proxy Considerations</div>
<ul>
<li>
<p>Note that Foreman&#160;server upgraded from 3.1 to nightly can use Smart&#160;Proxy&#160;servers still at 3.1.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="upgrading_a_connected_satellite_server"><a class="anchor" href="#upgrading_a_connected_satellite_server"></a>2.1.1. Upgrading a Connected Foreman&#160;server</h4>
<div class="paragraph">
<p>Use this procedure for a Foreman&#160;server with access to the public internet</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you customize configuration files, manually or using a tool such as Hiera, these changes are overwritten when the installation script runs during upgrading or updating.
You can use the <code>--noop</code> option with the foreman-installer script to test for changes.
For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in Foreman config files during an upgrade.</a>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Upgrade Foreman&#160;server</div>
<ol class="arabic">
<li>
<p>Create a backup.</p>
<div class="ulist">
<ul>
<li>
<p>On a virtual machine, take a snapshot.</p>
</li>
<li>
<p>On a physical machine, create a backup.</p>
<div class="paragraph">
<p>For more information about backups, see <a href="https://docs.theforeman.org/nightly/Administering_Red_Hat_Satellite/index-foreman-deb.html#Backing_Up_Server_and_Proxy_admin">Backing Up Foreman&#160;server and Smart&#160;Proxy&#160;server</a> in the <em>Administering Foreman 3.1</em> guide.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration in the <code>/etc/zones.conf</code> or <code>/etc/dhcp/dhcpd.conf</code> files, back up the configuration files because the installer only supports one domain or subnet, and therefore restoring changes from these backups might be required.</p>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration files and do not want to overwrite the changes, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-installer --foreman-proxy-dns-managed=false \
--foreman-proxy-dhcp-managed=false</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Discovered hosts</strong>.
On the Discovered Hosts page, power off and then delete the discovered hosts.
From the <strong>Select an Organization</strong> menu, select each organization in turn and repeat the process to power off and delete the discovered hosts.
Make a note to reboot these hosts when the upgrade is complete.</p>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre># reboot</pre>
</div>
</div>
</li>
<li>
<p>If using a BASH shell, after a successful or failed upgrade, enter:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># hash -d foreman-maintain service 2> /dev/null</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_capsule_server"><a class="anchor" href="#upgrading_capsule_server"></a>2.2. Upgrading Smart&#160;Proxy&#160;servers</h3>
<div class="paragraph">
<p>This section describes how to upgrade Smart&#160;Proxy&#160;servers from 3.1 to nightly.</p>
</div>
<div class="ulist">
<div class="title">Before You Begin</div>
<ul>
<li>
<p>You must upgrade Foreman&#160;server before you can upgrade any Smart&#160;Proxy&#160;servers.
Note that you can upgrade Smart&#160;Proxies separately from Foreman.
For more information, see <a href="#Upgrading_Proxies_Separately_from_Server_upgrade-guide">Upgrading Smart&#160;Proxies Separately from Foreman</a>.</p>
</li>
<li>
<p>If you use Content Views to control updates to the base operating system of Smart&#160;Proxy&#160;server, update those Content Views with new repositories and publish their updated versions.
For more information, see <a href="https://docs.theforeman.org/nightly/Content_Management_Guide/index-foreman-deb.html#Managing_Content_Views_content-management">Managing Content Views</a> in the <em>Content Management Guide</em>.</p>
</li>
<li>
<p>Ensure the Smart&#160;Proxy&#8217;s base system is registered to the newly upgraded Foreman&#160;server.</p>
</li>
<li>
<p>Ensure the Smart&#160;Proxy has the correct organization and location settings in the newly upgraded Foreman&#160;server.</p>
</li>
<li>
<p>Review and update your firewall configuration prior to upgrading your Smart&#160;Proxy&#160;server.
For more information, see <a href="https://docs.theforeman.org/nightly/Installing_Proxy_on_Debian/index-foreman-deb.html#preparing-environment-for-capsule-installation">Preparing Your Environment for Smart&#160;Proxy Installation</a> in <em>Installing Smart&#160;Proxy&#160;server</em>.</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">Upgrading Smart&#160;Proxy&#160;servers</div>
<ol class="arabic">
<li>
<p>Create a backup.</p>
<div class="ulist">
<ul>
<li>
<p>On a virtual machine, take a snapshot.</p>
</li>
<li>
<p>On a physical machine, create a backup.</p>
<div class="paragraph">
<p>For information on backups, see <a href="https://docs.theforeman.org/nightly/Administering_Red_Hat_Satellite/index-foreman-deb.html#Backing_Up_Server_and_Proxy_admin">Backing Up Foreman&#160;server and Smart&#160;Proxy&#160;server</a> in the <em>Administering Foreman 3.1</em> guide.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre># reboot</pre>
</div>
</div>
</li>
<li>
<p>Optional: If you made manual edits to DNS or DHCP configuration files, check and restore any changes required to the DNS and DHCP configuration files using the backups made earlier.</p>
</li>
<li>
<p>Optional: If you use custom repositories, ensure that you enable these custom repositories after the upgrade completes.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="post-upgrade_tasks"><a class="anchor" href="#post-upgrade_tasks"></a>2.2.1. Post-Upgrade Tasks</h4>
<div class="paragraph">
<p>Some of the procedures in this section are optional.
You can choose to perform only those procedures that are relevant to your installation.</p>
</div>
<div class="paragraph">
<p>If you use the PXE-based discovery process, then you must complete the discovery upgrade procedure on Foreman and on any Smart&#160;Proxy&#160;server with hosts that you want to be listed in Foreman on the <strong>Hosts</strong> &gt; <strong>Discovered hosts</strong> page.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="upgrading_discovery_parent"><a class="anchor" href="#upgrading_discovery_parent"></a>2.3. Upgrading Discovery</h3>
<div class="paragraph">
<p>This section describes updating the PXELinux template and the boot image passed to hosts that use PXE booting to register themselves with Foreman&#160;server.</p>
</div>
<div class="paragraph">
<p>From Foreman&#160;1.22, provisioning templates now have a separate association with a subnet, and do not default to using the TFTP Smart&#160;Proxy for that subnet.
If you create subnets after the upgrade, you must specifically enable the Foreman or a Smart&#160;Proxy to provide a proxy service for discovery templates and then configure all subnets with discovered hosts to use a specific <em>template Smart&#160;Proxy</em>.</p>
</div>
<div class="paragraph">
<p>During the upgrade, for every subnet with a TFTP proxy enabled, the template Smart&#160;Proxy is set to be the same as the TFTP Smart&#160;Proxy.
After the upgrade, check all subnets to verify this was set correctly.</p>
</div>
<div class="paragraph">
<p>These procedures are not required if you do not use PXE booting of hosts to enable Foreman to discover new hosts.</p>
</div>
<div class="sect3">
<h4 id="upgrading_discovery_satellite"><a class="anchor" href="#upgrading_discovery_satellite"></a>2.3.1. Upgrading Discovery on Foreman&#160;server</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Update the Discovery template in the Foreman web UI:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning templates</strong>.</p>
</li>
<li>
<p>On the <code>PXELinux global default</code> line, click <strong>Clone</strong>.</p>
</li>
<li>
<p>Enter a new name for the template in the <strong>Name</strong> field, for example <code>ACME PXE global default</code>.</p>
</li>
<li>
<p>In the template editor field, change the line <code>ONTIMEOUT local</code> to <code>ONTIMEOUT discovery</code> and click <strong>Submit</strong>.</p>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Administer</strong> &gt; <strong>Settings</strong>.</p>
</li>
<li>
<p>Locate <code>Global default PXELinux template</code> and click on its <strong>Value</strong>.</p>
</li>
<li>
<p>Select the name of the newly created template from the menu and click the tick button.</p>
</li>
<li>
<p>In the Foreman web UI, navigate to <strong>Hosts</strong> &gt; <strong>Provisioning templates</strong>.</p>
</li>
<li>
<p>Click <strong>Build PXE Default</strong>, then click <strong>OK</strong>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>In the Foreman web UI, go to <strong>Configure</strong> &gt; <strong>Discovery Rules</strong> and associate selected organizations and locations with discovery rules.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="upgrading_discovery_capsule"><a class="anchor" href="#upgrading_discovery_capsule"></a>2.3.2. Upgrading Discovery on Smart&#160;Proxy&#160;servers</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify that the Foreman Discovery package is current on Foreman&#160;server.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install tfm-rubygem-foreman_discovery</pre>
</div>
</div>
</li>
<li>
<p>If an update occurred in the previous step, restart the <code>foreman-maintain</code> services.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain service restart</pre>
</div>
</div>
</li>
<li>
<p>Upgrade the Discovery image on the Foreman Smart&#160;Proxy that is either connected to the provisioning network with discovered hosts or provides TFTP services for discovered hosts.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install foreman-discovery-image</pre>
</div>
</div>
</li>
<li>
<p>On the same instance, install the package which provides the Proxy service, and then restart <code>foreman-proxy</code> service.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># apt-get install tfm-rubygem-smart_proxy_discovery
# service foreman-proxy restart</pre>
</div>
</div>
</li>
<li>
<p>In the Foreman web UI, go to <strong>Infrastructure</strong> &gt; <strong>Smart&#160;Proxies</strong> and verify that the relevant Smart&#160;Proxy lists <strong>Discovery</strong> in the features column.
Select <strong>Refresh</strong> from the <strong>Actions</strong> drop-down menu if necessary.</p>
</li>
<li>
<p>Go to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong> and for each subnet on which you want to use discovery:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Click the subnet name.</p>
</li>
<li>
<p>On the <strong>Smart&#160;Proxies</strong> tab, ensure the <strong>Discovery Smart&#160;Proxy</strong> is set to a Smart&#160;Proxy you configured above.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="verify_subnets_have_a_template_capsule"><a class="anchor" href="#verify_subnets_have_a_template_capsule"></a>2.3.3. Verifying Subnets have a Template Smart&#160;Proxy</h4>
<div class="olist arabic">
<div class="title">Ensure all subnets with discovered hosts have a template Smart&#160;Proxy:</div>
<ol class="arabic">
<li>
<p>In the Foreman web UI, navigate to <strong>Infrastructure</strong> &gt; <strong>Subnets</strong>.</p>
</li>
<li>
<p>Select the subnet you want to check.</p>
</li>
<li>
<p>On the <strong>Smart&#160;Proxies</strong> tab, ensure a <strong>Template Smart&#160;Proxy</strong> has been set for this subnet.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information about configuring subnets with template Smart&#160;Proxies, see <a href="https://docs.theforeman.org/nightly/Provisioning_Guide/index-foreman-deb.html#Configuring_the_Discovery_Service_provisioning">Configuring the Discovery Service</a> in the <em>Provisioning</em> guide.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="reclaiming-postgresql-space-after-an-upgrade_upgrade-guide"><a class="anchor" href="#reclaiming-postgresql-space-after-an-upgrade_upgrade-guide"></a>2.4. Reclaiming PostgreSQL Space</h3>
<div class="paragraph">
<p>The PostgreSQL database can use a large amount of disk space especially in heavily loaded deployments.
Use this procedure to reclaim some of this disk space on Foreman.</p>
</div>
<div class="olist arabic">
<div class="title">Procedure</div>
<ol class="arabic">
<li>
<p>Stop all services, except for the <code>postgresql</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain service stop --exclude postgresql</pre>
</div>
</div>
</li>
<li>
<p>Switch to the <code>postgres</code> user and reclaim space on the database:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># su - postgres -c 'vacuumdb --full --dbname=foreman'</pre>
</div>
</div>
</li>
<li>
<p>Start the other services when the vacuum completes:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain service start</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="introduction_updating_satellite" class="paragraph">
<p>Use this chapter to update your existing Foreman&#160;server, Smart&#160;Proxy&#160;server, and Content Hosts to a new minor version, for example, from nightly.0 to nightly.1.</p>
</div>
<div class="paragraph">
<p>Updates patch security vulnerabilities and minor issues discovered after code is released, and are often fast and non-disruptive to your operating environment.</p>
</div>
<div class="paragraph">
<p>Before updating, back up your Foreman&#160;server and all Smart&#160;Proxy&#160;servers.
For more information, see <a href="https://docs.theforeman.org/nightly/Administering_Red_Hat_Satellite/index-foreman-deb.html#Backing_Up_Server_and_Proxy_admin">Backing Up Foreman&#160;server and Smart&#160;Proxy&#160;server</a> in the <em>Administering Foreman</em> guide.</p>
</div>
</div>
<div class="sect2">
<h3 id="updating_satellite_server_to_next_minor_version"><a class="anchor" href="#updating_satellite_server_to_next_minor_version"></a>2.5. Updating Foreman&#160;server</h3>
<div class="ulist">
<div class="title">Prerequisites</div>
<ul>
<li>
<p>Ensure that you have synchronized Foreman&#160;server repositories for Foreman, Smart&#160;Proxy, and <a href="https://yum.theforeman.org/client/nightly/" class="bare">https://yum.theforeman.org/client/nightly/</a>.</p>
</li>
<li>
<p>Ensure each external Smart&#160;Proxy and Content Host can be updated by promoting the updated repositories to all relevant Content Views.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
If you customize configuration files, manually or use a tool such as Hiera, these customizations are overwritten when the installation script runs during upgrading or updating.
You can use the <code>--noop</code> option with the foreman-installer script to test for changes.
For more information, see the Red Hat Knowledgebase solution <a href="https://access.redhat.com/solutions/3351311">How to use the noop option to check for changes in Foreman config files during an upgrade</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Updating Foreman&#160;server to the Next Minor Version</strong></p>
</div>
<div class="olist arabic">
<div class="title">To Update Foreman&#160;server:</div>
<ol class="arabic">
<li>
<p>Ensure the Foreman Maintenance repository is enabled:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># subscription-manager repos --enable \
rhel-7-server-satellite-maintenance-6-rpms</pre>
</div>
</div>
</li>
<li>
<p>Check the available versions to confirm the next minor version is listed:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade list-versions</pre>
</div>
</div>
</li>
<li>
<p>Use the health check option to determine if the system is ready for upgrade.
On first use of this command, <code>foreman-maintain</code> prompts you to enter the hammer admin user credentials and saves them in the <code>/etc/foreman-maintain/foreman-maintain-hammer.yml</code> file.</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade check --target-version nightly.<em>z</em></pre>
</div>
</div>
<div class="paragraph">
<p>Review the results and address any highlighted error conditions before performing the upgrade.</p>
</div>
</li>
<li>
<p>Because of the lengthy update time, use a utility such as <code>screen</code> to suspend and reattach a communication session.
You can then check the upgrade progress without staying connected to the command shell continuously.
For more information about using the screen command, see <a href="https://access.redhat.com/articles/5247">How do I use the screen command?</a> article in the <em>Red&#160;Hat Knowledge&#160;Base</em>.</p>
<div class="paragraph">
<p>If you lose connection to the command shell where the upgrade command is running, you can see the logged messages in the <code>/var/log/foreman-installer/foreman.log</code> file to check if the process completed successfully.</p>
</div>
</li>
<li>
<p>Perform the upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain upgrade run --target-version nightly.<em>z</em></pre>
</div>
</div>
</li>
<li>
<p>Check when the kernel packages were last updated:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># rpm -qa --last | grep kernel</pre>
</div>
</div>
</li>
<li>
<p>Optional: If a kernel update occurred since the last reboot, stop the <code>foreman-maintain</code> services and reboot the system:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap"># foreman-maintain service stop
# reboot</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated Jan 2022
</div>
</div>
</body>
</html>